volumes:
    minio-data:
    pgduck-unix-socket-volume:
    pg-shared-tmp-dir-volume: # Shared temp directory for both PostgreSQL and pgduck_server

services:
    minio:
        image: quay.io/minio/minio:latest
        ports:
            # API port
            - "9000:9000"
            # UI port
            - "9001:9001"
        environment:
            MINIO_ROOT_USER: minio_root
            MINIO_ROOT_PASSWORD: m1n1opwd
        command:
            - "server"
            - "/data"
            - "--console-address"
            - ":9001"
        volumes:
            - minio-data:/data
        healthcheck:
            test: ["CMD", "curl", "http://127.0.0.1:9000/minio/health/live"]
            interval: 1s
            timeout: 10s

    setup_bucket:
        image: quay.io/minio/mc:latest
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: "/bin/sh"
        command:
            - "-c"
            - >-
                echo Creating MinIO bucket...;
                mc alias set pol http://minio:9000 minio_root m1n1opwd;
                mc mb pol/warehouse;
                mc mb pol/data;
                mc ls pol;
                echo Bucket setup complete.;

    pg_lake-postgres:
        image: pg_lake:local
        pull_policy: if_not_present
        container_name: pg_lake
        ports:
            - "5432:5432"
        volumes:
            - ./scripts/entrypoint-postgres.sh:/entrypoint-postgres.sh
            - ./scripts/init-postgres.sql:/init-postgres.sql
            - pgduck-unix-socket-volume:/home/postgres/pgduck_socket_dir
            - pg-shared-tmp-dir-volume:/home/postgres/pgsql-18/data/base/pgsql_tmp
        entrypoint: ["/entrypoint-postgres.sh"]
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "psql",
                    "-c",
                    "create table test(a int) using iceberg; drop table test;",
                ]
            interval: 6s
            timeout: 2s
            start_period: 20s
            retries: 3
        cap_add:
            - SYS_PTRACE
        depends_on:
            - pgduck-server

    pgduck-server:
        image: pgduck-server:local
        pull_policy: if_not_present
        container_name: pgduck-server
        # NOTE: pgduck-server only listens on Unix sockets, not TCP
        # To access DuckDB from the host, connect via pg_lake-postgres container which shares the Unix socket
        # Example: psql -h localhost -p 5432 -U postgres -c "SELECT * FROM duckdb_fdw.some_table"
        # IMPORTANT: Both containers must share the same temp directory volume so pgduck_server can access temp files
        volumes:
            - ./scripts/entrypoint-pgduck-server.sh:/entrypoint-pgduck-server.sh
            - ./scripts/init-pgduck-server.sql:/init-pgduck-server.sql
            - pgduck-unix-socket-volume:/home/postgres/pgduck_socket_dir
            - pg-shared-tmp-dir-volume:/home/postgres/pgsql-18/data/base/pgsql_tmp
        entrypoint: ["/entrypoint-pgduck-server.sh"]
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "psql",
                    "-p",
                    "5332",
                    "-h",
                    "/home/postgres/pgduck_socket_dir",
                    "-c",
                    "SELECT 1;",
                ]
            interval: 6s
            timeout: 2s
            start_period: 20s
            retries: 3
        cap_add:
            - SYS_PTRACE
        depends_on:
            - minio
